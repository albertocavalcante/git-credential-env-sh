#!/usr/bin/env sh
set -eu

action="${1:-}"
case "$action" in
  get|store|erase) ;;
  *)
    echo "usage: git-credential-ghenv-sh <get|store|erase>" >&2
    exit 1
    ;;
esac

protocol=""
host=""
path=""

while IFS= read -r line; do
  [ -z "$line" ] && break

  key=${line%%=*}
  value=${line#*=}

  case "$key" in
    protocol) protocol="$value" ;;
    host) host="$value" ;;
    path) path="$value" ;;
  esac
done

[ "$action" = "get" ] || exit 0

token_env="${GIT_CREDENTIAL_TOKEN_ENV:-GIT_CREDENTIAL_TOKEN}"
token="$(printenv "$token_env" 2>/dev/null || true)"
[ -n "$token" ] || exit 0

expected_protocol="${GIT_CREDENTIAL_PROTOCOL:-https}"
expected_host="${GIT_CREDENTIAL_HOST:-github.com}"
username="${GIT_CREDENTIAL_USERNAME:-x-access-token}"
path_prefix="${GIT_CREDENTIAL_PATH_PREFIX:-}"

if [ -n "$protocol" ] && [ "$protocol" != "$expected_protocol" ]; then
  exit 0
fi

[ -n "$host" ] || exit 0
host_no_port="${host%%:*}"
[ "$host_no_port" = "$expected_host" ] || exit 0

if [ -n "$path_prefix" ]; then
  case "$path" in
    "$path_prefix"*) ;;
    *) exit 0 ;;
  esac
fi

printf 'username=%s\n' "$username"
printf 'password=%s\n\n' "$token"
